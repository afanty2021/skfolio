# 先验估计

<cite>
**本文档中引用的文件**  
- [__init__.py](file://src/skfolio/prior/__init__.py)
- [_base.py](file://src/skfolio/prior/_base.py)
- [_empirical.py](file://src/skfolio/prior/_empirical.py)
- [_black_litterman.py](file://src/skfolio/prior/_black_litterman.py)
- [_entropy_pooling.py](file://src/skfolio/prior/_entropy_pooling.py)
- [_opinion_pooling.py](file://src/skfolio/prior/_opinion_pooling.py)
- [_factor_model.py](file://src/skfolio/prior/_factor_model.py)
- [plot_11_empirical_prior.py](file://examples/mean_risk/plot_11_empirical_prior.py)
- [plot_12_black_and_litterman.py](file://examples/mean_risk/plot_12_black_and_litterman.py)
- [plot_13_factor_model.py](file://examples/mean_risk/plot_13_factor_model.py)
- [plot_14_black_litterman_factor_model.py](file://examples/mean_risk/plot_14_black_litterman_factor_model.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心先验估计器](#核心先验估计器)
3. [简单先验：EmpiricalPrior](#简单先验empiricalprior)
4. [高级先验：Black-Litterman模型](#高级先验black-litterman模型)
5. [协方差建模：FactorModel](#协方差建模factormodel)
6. [定性观点量化：EntropyPooling与OpinionPooling](#定性观点量化entropypooling与opinionpooling)
7. [先验估计器在优化中的应用](#先验估计器在优化中的应用)
8. [完整示例分析](#完整示例分析)
9. [结论](#结论)

## 简介
先验估计模块是投资组合优化的核心，它负责为优化器提供资产收益分布的先验信息，包括预期收益、协方差矩阵和收益数据。该模块通过多种估计器，从简单的经验估计到复杂的贝叶斯模型，为投资组合构建提供灵活且强大的先验信息。本文件将详细阐述`EmpiricalPrior`、`BlackLitterman`、`FactorModel`、`EntropyPooling`和`OpinionPooling`等核心估计器的原理、实现和应用。

## 核心先验估计器
先验估计模块的核心是`BasePrior`基类，所有具体的先验估计器都继承自此类。其核心输出是`ReturnDistribution`数据类，它封装了优化器所需的所有先验信息：预期收益（mu）、协方差矩阵（covariance）、收益数据（returns）、Cholesky分解（cholesky）和样本权重（sample_weight）。这些估计器通过`fit`方法接收资产收益数据`X`，并生成一个`return_distribution_`对象，该对象随后被传递给优化器。

**Section sources**
- [__init__.py](file://src/skfolio/prior/__init__.py#L3-L26)
- [_base.py](file://src/skfolio/prior/_base.py#L15-L49)

## 简单先验：EmpiricalPrior
`EmpiricalPrior`是最基础的先验估计方法，它通过分别拟合预期收益估计器（`mu_estimator`）和协方差矩阵估计器（`covariance_estimator`）来构建先验分布。其默认配置使用`EmpiricalMu`和`EmpiricalCovariance`，即直接计算历史数据的均值和协方差。该估计器还支持对数正态假设，通过`is_log_normal`和`investment_horizon`参数，将对数收益的估计结果转换为特定投资期限下的线性收益估计，从而更准确地反映复利效应。

**Section sources**
- [_empirical.py](file://src/skfolio/prior/_empirical.py#L17-L205)

## 高级先验：Black-Litterman模型
`BlackLitterman`模型采用贝叶斯方法，将市场均衡收益（作为先验）与投资者的主观观点（作为似然）相结合，生成一个后验的预期收益估计。该模型通过`views`参数接收投资者观点，支持绝对观点（如"SPX = 0.00015"）和相对观点（如"SX5E - TLT = 0.00039"）。`tau`参数控制对观点的不确定性，值越小表示对观点的不确定性越高，从而给予先验更大的权重。该模型首先使用`prior_estimator`（默认为基于均衡收益的`EmpiricalPrior`）估计先验分布，然后根据观点和不确定性矩阵（Omega）计算后验收益和协方差。

**Section sources**
- [_black_litterman.py](file://src/skfolio/prior/_black_litterman.py#L22-L269)

## 协方差建模：FactorModel
`FactorModel`通过因子模型来估计协方差矩阵，旨在通过少量共同因子来解释资产收益的变动，从而降低估计误差。该模型由两部分组成：`loading_matrix_estimator`（默认为`LoadingMatrixRegression`）用于估计每个资产对各因子的暴露度（beta），`factor_prior_estimator`（默认为`EmpiricalPrior`）用于估计因子本身的收益分布。最终的资产协方差矩阵由因子协方差矩阵通过因子载荷矩阵映射而来，并可选择性地加入残差方差。`higham`参数可用于确保最终的协方差矩阵是半正定的。

**Section sources**
- [_factor_model.py](file://src/skfolio/prior/_factor_model.py#L148-L347)

## 定性观点量化：EntropyPooling与OpinionPooling
`EntropyPooling`和`OpinionPooling`是将定性观点融入先验的强大工具。`EntropyPooling`通过最小化后验分布与先验分布之间的相对熵（Kullback-Leibler散度），在满足用户定义的约束（如均值、方差、VaR、CVaR等）下，调整历史数据的样本权重。它支持等式、不等式和排序等多种约束类型。`OpinionPooling`则用于聚合多个专家或模型的观点，通过线性（算术平均）或对数（几何平均）池化方法，结合`divergence_penalty`参数对偏离共识的观点进行降权，生成一个共识性的先验分布。

**Section sources**
- [_entropy_pooling.py](file://src/skfolio/prior/_entropy_pooling.py#L38-L800)
- [_opinion_pooling.py](file://src/skfolio/prior/_opinion_pooling.py#L25-L476)

## 先验估计器在优化中的应用
先验估计器通过`prior_estimator`参数传递给优化器（如`MeanRisk`、`HierarchicalRiskParity`等）。优化器在求解最优权重时，会使用`return_distribution_`中的`mu`和`covariance`作为目标函数和约束的输入。例如，在均值-方差优化中，`mu`作为预期收益，`covariance`作为风险度量。通过使用`EntropyPooling`或`BlackLitterman`等更复杂的先验，可以将投资者的观点直接融入优化过程，从而生成更符合主观判断的投资组合。

**Section sources**
- [plot_11_empirical_prior.py](file://examples/mean_risk/plot_11_empirical_prior.py)
- [plot_12_black_and_litterman.py](file://examples/mean_risk/plot_12_black_and_litterman.py)

## 完整示例分析
通过分析`plot_12_black_and_litterman.py`和`plot_13_factor_model.py`等示例，可以清晰地看到这些估计器的实际应用。例如，在`BlackLitterman`示例中，通过定义`views`（如"SPX = 0.30"）和`groups`，模型成功地将投资者对市场表现的乐观观点融入先验，导致优化后的投资组合在SPX上的权重显著增加。在`FactorModel`示例中，通过使用宏观经济因子数据，模型能够构建一个结构化的协方差矩阵，使得优化结果对历史数据的噪声更具鲁棒性。这些示例的输出结果清晰地展示了不同先验对最终投资组合权重的显著影响。

**Section sources**
- [plot_12_black_and_litterman.py](file://examples/mean_risk/plot_12_black_and_litterman.py)
- [plot_13_factor_model.py](file://examples/mean_risk/plot_13_factor_model.py)

## 结论
skfolio的先验估计模块提供了一个从简单到复杂、从定量到定性的完整工具链。`EmpiricalPrior`为基准提供了简单直接的估计，`BlackLitterman`和`FactorModel`则分别从收益和风险的角度引入了更高级的建模方法。`EntropyPooling`和`OpinionPooling`作为创新性的工具，能够将难以量化的定性观点系统地融入投资决策过程。通过将这些估计器作为参数传递给优化器，用户可以构建出既符合数据规律又体现主观判断的、稳健的投资组合。