# 均值-风险优化

<cite>
**本文档引用的文件**   
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py)
- [plot_1_maximum_sharpe_ratio.py](file://examples/mean_risk/plot_1_maximum_sharpe_ratio.py)
- [plot_2_minimum_CVaR.py](file://examples/mean_risk/plot_2_minimum_CVaR.py)
- [plot_3_efficient_frontier.py](file://examples/mean_risk/plot_3_efficient_frontier.py)
- [plot_5_weight_constraints.py](file://examples/mean_risk/plot_5_weight_constraints.py)
- [plot_6_transaction_costs.py](file://examples/mean_risk/plot_6_transaction_costs.py)
- [plot_7_management_fees.py](file://examples/mean_risk/plot_7_management_fees.py)
- [plot_8_regularization.py](file://examples/mean_risk/plot_8_regularization.py)
- [plot_9_uncertainty_set.py](file://examples/mean_risk/plot_9_uncertainty_set.py)
- [plot_10_tracking_error.py](file://examples/mean_risk/plot_10_tracking_error.py)
- [plot_15_mip_cardinality_constraints.py](file://examples/mean_risk/plot_15_mip_cardinality_constraints.py)
- [_base.py](file://src/skfolio/optimization/convex/_base.py)
- [_enums.py](file://src/skfolio/measures/_enums.py)
</cite>

## 目录
1. [引言](#引言)
2. [核心目标函数与数学表达式](#核心目标函数与数学表达式)
3. [风险度量与目标函数配置](#风险度量与目标函数配置)
4. [权重约束与线性约束建模](#权重约束与线性约束建模)
5. [交易成本、管理费与正则化项](#交易成本管理费与正则化项)
6. [不确定性集与鲁棒优化](#不确定性集与鲁棒优化)
7. [高效前沿与多目标优化](#高效前沿与多目标优化)
8. [求解器选择与数值稳定性](#求解器选择与数值稳定性)
9. [综合应用示例分析](#综合应用示例分析)
10. [结论](#结论)

## 引言

均值-风险优化是现代投资组合理论的核心，它通过在预期收益和风险之间进行权衡来构建最优投资组合。`MeanRisk`优化器是`skfolio`库中实现这一理论的核心组件，它提供了一个高度灵活和可扩展的框架，支持多种风险度量、目标函数和约束条件。本文档将深入探讨`MeanRisk`优化器的实现机制，详细解释其支持的三种主要目标函数：最小化风险、最大化夏普比率和最大化效用函数，以及对应的数学表达式和求解方式。我们将阐述如何通过`risk_measure`和`objective`参数进行配置，并说明权重约束、交易成本、管理费和正则化项的建模方法及其对优化结果的影响。通过分析`examples/mean_risk`目录下的多个示例脚本，我们将展示从基础的最大化夏普比率到复杂约束条件下的实际应用，为用户提供一个全面的API参数详解、求解器选择建议和性能调优策略。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L31-L800)

## 核心目标函数与数学表达式

`MeanRisk`优化器的核心在于其支持的四种目标函数，这些函数定义了优化问题的求解方向。每种目标函数都对应一个特定的数学规划问题，通过`objective_function`参数进行配置。

### 最小化风险

最小化风险是`MeanRisk`优化器的默认目标。其数学表达式如下：

```math
\begin{cases}
\begin{aligned}
&\min_{w} & & risk_{i}(w) \\
&\text{s.t.} & & w^T \cdot \mu \ge min\_return \\
& & & A \cdot w \ge b \\
& & & risk_{j}(w) \le max\_risk_{j} \quad \forall \; j \ne i
\end{aligned}
\end{cases}
```

该目标函数旨在在满足最低预期收益（`min_return`）和一系列线性不等式约束（`A·w ≥ b`）以及其他风险度量上限的前提下，最小化由`risk_measure`参数指定的主要风险度量`risk_i(w)`。这适用于风险厌恶型投资者，他们希望在保证一定收益水平的同时，尽可能降低投资组合的整体风险。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L36-L45)

### 最大化夏普比率

最大化夏普比率（在`skfolio`中通过`MAXIMIZE_RATIO`目标函数实现）旨在找到单位风险所能获得的最高超额收益。其数学表达式为：

```math
\begin{cases}
\begin{aligned}
&\max_{w} & & \frac{w^T \cdot \mu - r_{f}}{risk_{i}(w)}\\
&\text{s.t.} & & risk_{i}(w) \le max\_risk_{i} \\
& & & w^T \cdot \mu \ge min\_return \\
& & & A \cdot w \ge b \\
& & & risk_{j}(w) \le max\_risk_{j} \quad \forall \; j \ne i
\end{aligned}
\end{cases}
```

其中，`r_f`是`risk_free_rate`参数指定的无风险利率。该目标函数将优化问题转化为一个分式规划问题。为了求解，`MeanRisk`优化器内部使用了同质化技术（如Charnes-Cooper变换），将原问题转化为一个等价的凸优化问题。值得注意的是，当`risk_measure`为`VARIANCE`时，优化器会发出警告，因为方差的平方根（标准差）才是与夏普比率同次的度量，推荐使用`STANDARD_DEVIATION`以获得更精确的夏普比率最大化。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L70-L79)
- [plot_1_maximum_sharpe_ratio.py](file://examples/mean_risk/plot_1_maximum_sharpe_ratio.py#L42-L46)

### 最大化效用函数

最大化效用函数结合了预期收益和风险，通过一个风险厌恶系数`λ`（`risk_aversion`参数）来量化投资者对风险的厌恶程度。其数学表达式为：

```math
\begin{cases}
\begin{aligned}
&\max_{w} & & w^T \cdot \mu - \lambda \times risk_{i}(w)\\
&\text{s.t.} & & risk_{i}(w) \le max\_risk_{i} \\
& & & w^T \cdot \mu \ge min\_return \\
& & & A \cdot w \ge b \\
& & & risk_{j}(w) \le max\_risk_{j} \quad \forall \; j \ne i
\end{aligned}
\end{cases}
```

该目标函数直接在目标函数中引入了风险惩罚项`λ × risk_i(w)`。`λ`值越大，表示投资者越厌恶风险，优化结果会倾向于选择风险更低但预期收益也更低的组合。这个框架非常灵活，可以看作是均值-方差优化的推广。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L58-L67)

## 风险度量与目标函数配置

`MeanRisk`优化器的强大之处在于其对多种风险度量的支持，这使得用户可以根据投资策略和市场环境选择最合适的度量方式。

### 支持的风险度量

`MeanRisk`优化器通过`risk_measure`参数支持以下风险度量：
*   **方差 (VARIANCE)** 和 **标准差 (STANDARD_DEVIATION)**：经典的均值-方差框架。
*   **半方差 (SEMI_VARIANCE)** 和 **半标准差 (SEMI_DEVIATION)**：只关注低于目标收益（`min_acceptable_return`）的下行风险。
*   **平均绝对偏差 (MEAN_ABSOLUTE_DEVIATION)**：对异常值的敏感度低于方差。
*   **条件风险价值 (CVaR)** 和 **期望短缺 (EVaR)**：衡量尾部风险，即在最坏情况下的平均损失。
*   **最大回撤 (MAX_DRAWDOWN)** 和 **条件回撤风险 (CDaR)**：衡量投资组合从峰值到谷值的最大损失。
*   **溃疡指数 (ULCER_INDEX)**：衡量价格波动的“痛苦”程度。

这些风险度量被定义在`RiskMeasure`枚举类中，确保了API的一致性和类型安全。

### 目标函数与风险度量的协同配置

`objective_function`和`risk_measure`参数是协同工作的。例如，要实现最小化CVaR的目标，需要将`objective_function`设置为`MINIMIZE_RISK`，并将`risk_measure`设置为`CVAR`。同样，要实现最大化夏普比率，需要将`objective_function`设置为`MAXIMIZE_RATIO`，并将`risk_measure`设置为`STANDARD_DEVIATION`。这种模块化的设计使得用户可以轻松地在不同的优化目标和风险偏好之间切换。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L82-L97)
- [_enums.py](file://src/skfolio/measures/_enums.py#L105-L186)

## 权重约束与线性约束建模

`MeanRisk`优化器提供了丰富的约束条件，用于将投资组合的实际限制融入优化过程。

### 基础权重约束

*   **`min_weights` 和 `max_weights`**: 分别定义了每个资产权重的下限和上限。例如，`min_weights=0`表示不允许卖空（长仓），而`max_weights=0.1`表示任何单一资产的权重不能超过10%。
*   **`budget`**: 定义了投资预算，即所有权重的总和。`budget=1.0`表示完全投资，`budget=0.0`表示市场中性（多空头寸总和为零）。
*   **`max_short` 和 `max_long`**: 分别限制了总卖空头寸（负权重的绝对值之和）和总多头头寸（正权重之和）的上限。

这些约束可以直接通过浮点数、数组或字典进行配置，字典形式允许为特定资产指定不同的约束。

### 高级线性约束

`MeanRisk`优化器支持通过`linear_constraints`参数定义复杂的线性约束。用户可以使用字符串表达式来描述约束，例如：
*   `"SPX >= 0.10"`：标普500指数的权重必须大于10%。
*   `"Technology + 1.5 * Industrial <= 2 * Financial"`：科技和工业板块的加权权重之和不能超过金融板块的两倍。
*   `"US == 0.7"`：所有美国资产的权重之和必须等于70%。

为了使用这些基于组的约束，需要通过`groups`参数预先定义资产的分组信息。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L156-L253)
- [plot_5_weight_constraints.py](file://examples/mean_risk/plot_5_weight_constraints.py#L179-L200)

## 交易成本、管理费与正则化项

`MeanRisk`优化器能够将实际投资中的成本和稳健性需求纳入优化模型。

### 交易成本与管理费

*   **`transaction_costs`**: 该参数用于建模交易成本。优化器会计算一个总成本项 `total_cost = Σ c_i * |w_i - w_prev_i|`，其中`c_i`是资产i的交易成本，`w_prev_i`是前一期的权重。这个总成本会从预期收益中扣除，从而影响最终的优化结果。成本的周期性必须与预期收益的周期性一致（例如，日度收益对应日度成本）。
*   **`management_fees`**: 该参数用于建模管理费。总费用 `total_fee = Σ f_i * w_i` 同样会从预期收益中扣除。与直接从收益率中减去费用相比，这种方法在使用收缩估计等技术时能避免引入偏差。

### 正则化项

*   **`l1_coef` (L1正则化)**: 通过惩罚权重的L1范数（`Σ |w_i|`）来增加模型的稳健性。L1正则化倾向于产生稀疏解，即许多权重为零，从而实现资产数量的自动选择（类似于特征选择）。
*   **`l2_coef` (L2正则化)**: 通过惩罚权重的L2范数（`Σ w_i²`）来增加模型的稳健性。L2正则化倾向于使权重分布更均匀，防止任何单一资产的权重过大，从而提高组合的分散化程度。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L255-L365)
- [plot_6_transaction_costs.py](file://examples/mean_risk/plot_6_transaction_costs.py#L14-L24)
- [plot_7_management_fees.py](file://examples/mean_risk/plot_7_management_fees.py#L12-L21)
- [plot_8_regularization.py](file://examples/mean_risk/plot_8_regularization.py#L11-L17)

## 不确定性集与鲁棒优化

为了应对参数估计误差带来的优化结果不稳定问题，`MeanRisk`优化器支持鲁棒优化。

### 预期收益的不确定性集

通过`mu_uncertainty_set_estimator`参数，可以为预期收益`μ`定义一个椭球形的不确定性集。优化器会采用最坏情况下的优化策略，其目标函数中的预期收益项被替换为：

```math
w^T \cdot \hat{\mu} - \kappa_{\mu} \lVert S_{\mu}^\frac{1}{2} \cdot w \rVert_{2}
```

其中，`κ_μ`是椭球的大小（置信区域），`S_μ`是其形状。这相当于在预期收益的估计值`μ_hat`上减去一个与权重向量相关的“安全边际”，从而降低了对精确估计的依赖，提高了投资组合的出样本稳定性。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L367-L379)
- [plot_9_uncertainty_set.py](file://examples/mean_risk/plot_9_uncertainty_set.py#L15-L20)

## 高效前沿与多目标优化

`MeanRisk`优化器能够高效地生成整个高效前沿。

### 高效前沿的生成

通过设置`efficient_frontier_size`参数，`MeanRisk`优化器可以自动计算出指定数量的帕累托最优投资组合。其内部实现方式是：首先计算出预期收益的最小值和最大值，然后在这两个极值之间均匀地划分出`efficient_frontier_size`个目标收益点。对于每一个目标收益点，优化器都会求解一个“最小化风险”的子问题，从而得到一个位于高效前沿上的点。最终，`predict`方法会返回一个包含所有这些投资组合的`Population`对象。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L151-L154)
- [plot_3_efficient_frontier.py](file://examples/mean_risk/plot_3_efficient_frontier.py#L36-L40)

## 求解器选择与数值稳定性

`MeanRisk`优化器的性能和稳定性在很大程度上取决于所选的求解器。

### 求解器选择

`MeanRisk`优化器通过`solver`参数指定求解器。默认求解器是`CLARABEL`，它用Rust编写，具有出色的数值稳定性和性能。其他可用的求解器包括`ECOS`、`SCS`，以及用于混合整数规划（如基数约束）的`SCIP`、`MOSEK`、`GUROBI`等。选择合适的求解器对于处理大规模或复杂问题至关重要。

### 数值稳定性处理

`MeanRisk`优化器内置了多种机制来提高数值稳定性：
*   **自动缩放 (`scale_objective`, `scale_constraints`)**: 优化器会根据目标函数和风险度量的类型，自动对目标函数和约束条件进行缩放，以避免因数值范围差异过大而导致求解失败。
*   **最优同质化因子**: 在求解最大化比率问题时，优化器会根据预期收益的均值动态计算一个最优的同质化因子，这有助于提高求解的收敛速度和鲁棒性。
*   **默认求解器参数**: 对于不同的求解器（如`CLARABEL`和`SCIP`），优化器会设置一组经过验证的默认参数，以确保最佳的求解性能。

**Section sources**
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L541-L554)
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L857-L867)
- [mean_risk.py](file://src/skfolio/optimization/convex/_mean_risk.py#L893-L921)

## 综合应用示例分析

`examples/mean_risk`目录下的脚本提供了`MeanRisk`优化器的完整应用范例。

### 基础应用

*   **`plot_1_maximum_sharpe_ratio.py`**: 展示了如何配置`MeanRisk`优化器以最大化夏普比率，并与等权重基准进行比较。
*   **`plot_2_minimum_CVaR.py`**: 展示了如何配置优化器以最小化CVaR，实现对尾部风险的控制。

### 复杂约束应用

*   **`plot_5_weight_constraints.py`**: 详细演示了如何使用`min_weights`、`max_weights`、`budget`以及`linear_constraints`等参数来施加各种权重和组约束。
*   **`plot_15_mip_cardinality_constraints.py`**: 展示了如何使用`cardinality`和`group_cardinalities`参数来限制投资组合中资产的总数或特定组内的资产数量，这需要使用`SCIP`等混合整数求解器。

### 成本与稳健性应用

*   **`plot_6_transaction_costs.py` 和 `plot_7_management_fees.py`**: 演示了如何将交易成本和管理费纳入优化过程，并通过滚动分析（Walk Forward Analysis）评估其对长期表现的影响。
*   **`plot_8_regularization.py` 和 `plot_9_uncertainty_set.py`**: 展示了如何使用L1/L2正则化和不确定性集来提高投资组合的稳健性，并通过交叉验证来调优相关超参数。

这些示例共同构成了一个从基础到高级的完整学习路径，帮助用户全面掌握`MeanRisk`优化器的使用。

**Section sources**
- [plot_1_maximum_sharpe_ratio.py](file://examples/mean_risk/plot_1_maximum_sharpe_ratio.py)
- [plot_2_minimum_CVaR.py](file://examples/mean_risk/plot_2_minimum_CVaR.py)
- [plot_5_weight_constraints.py](file://examples/mean_risk/plot_5_weight_constraints.py)
- [plot_6_transaction_costs.py](file://examples/mean_risk/plot_6_transaction_costs.py)
- [plot_7_management_fees.py](file://examples/mean_risk/plot_7_management_fees.py)
- [plot_8_regularization.py](file://examples/mean_risk/plot_8_regularization.py)
- [plot_9_uncertainty_set.py](file://examples/mean_risk/plot_9_uncertainty_set.py)
- [plot_15_mip_cardinality_constraints.py](file://examples/mean_risk/plot_15_mip_cardinality_constraints.py)

## 结论

`MeanRisk`优化器是一个功能强大且设计精良的投资组合优化工具。它通过清晰的参数化设计，将复杂的数学优化问题转化为直观的API调用。通过对目标函数、风险度量、各类约束、成本项和正则化项的灵活配置，用户可以构建出高度定制化的投资策略。其内置的鲁棒优化机制和对高效前沿的自动化生成，进一步提升了模型的实用性和分析深度。结合`skfolio`库中强大的分析和可视化工具，`MeanRisk`优化器为量化投资研究和实践提供了一个坚实而高效的平台。用户应根据自身的投资目标和约束，仔细选择和调优各项参数，并利用示例脚本作为起点，逐步构建和完善自己的投资组合优化模型。