# 风险预算优化

<cite>
**本文档中引用的文件**   
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py)
- [plot_1_risk_parity_variance.py](file://examples/risk_budgeting/plot_1_risk_parity_variance.py)
- [plot_2_risk_budgeting_CVaR.py](file://examples/risk_budgeting/plot_2_risk_budgeting_CVaR.py)
- [plot_3_risk_parity_ledoit_wolf.py](file://examples/risk_budgeting/plot_3_risk_parity_ledoit_wolf.py)
- [measures.py](file://src/skfolio/measures/_enums.py)
</cite>

## 目录
1. [简介](#简介)
2. [核心参数：风险预算向量](#核心参数风险预算向量)
3. [凸优化转换：log(w)变换](#凸优化转换logw变换)
4. [支持的风险度量类型](#支持的风险度量类型)
5. [约束条件](#约束条件)
6. [与风险平价的关系](#与风险平价的关系)
7. [代码示例](#代码示例)
8. [应用场景](#应用场景)

## 简介
风险预算优化（Risk Budgeting）是一种先进的投资组合优化技术，它允许投资者为不同资产分配不同的风险贡献。该方法通过求解一个凸优化问题，最小化投资组合的整体风险，同时确保每个资产的风险贡献符合预设的预算。当所有资产的风险预算相等时，该方法退化为风险平价（Risk Parity）策略。本API文档详细介绍了`RiskBudgeting`优化器的配置方法、数学原理和实际应用。

## 核心参数：风险预算向量
风险预算向量（`risk_budget`）是`RiskBudgeting`优化器的核心参数，它定义了每个资产在投资组合总风险中应承担的份额。该参数决定了优化问题的约束条件，从而直接影响最终的投资组合权重。

- **数据类型**：可以是字典、数组或`None`。
- **默认值**：`None`。当未指定时，系统会自动将其设置为全1向量，此时优化器执行风险平价策略。
- **字典格式**：如果输入为字典，其键（key）应为资产名称，值（value）为对应的风险预算。例如，`{"AAPL": 1.5, "GE": 0.2, "JPM": 0.2}`表示为苹果公司分配1.5单位的风险预算，为通用电气和摩根大通各分配0.2单位。
- **数组格式**：如果输入为数组，其长度必须与资产数量一致，每个元素对应一个资产的风险预算。
- **实现细节**：在代码实现中，如果`risk_budget`为`None`，则初始化为`np.ones(n_assets)`。对于非`None`的输入，会通过`_clean_input`方法进行清洗和填充，确保其为有效数组。

**Section sources**
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L93-L100)
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L528-L539)

## 凸优化转换：log(w)变换
`RiskBudgeting`优化器的核心创新在于使用`log(w)`变换将一个非凸的原始问题转化为一个可解的凸优化问题。

- **原始问题**：在风险预算优化中，目标是让每个资产的风险贡献（Risk Contribution）与其风险预算成正比。风险贡献通常与权重`w`和风险度量的梯度相关，这导致原始问题在`w`空间中是非凸的。
- **变换方法**：通过引入`log(w)`变换，优化器将决策变量从权重`w`转变为`log(w)`。在`RiskBudgeting`类的`fit`方法中，这一变换体现在风险预算约束的构建上：
    ```python
    constraints = [risk_budget @ cp.log(w) * self._scale_constraints >= 0]
    ```
- **凸性保证**：`log(w)`函数在`w > 0`的区域内是凹函数，而`cp.log(w)`是CVXPY中的原子函数，其使用确保了整个优化问题的凸性。这使得问题可以使用高效的凸优化求解器（如CLARABEL）进行求解。
- **约束解释**：该约束`budget^T log(w) >= 0`（在代码中通过`self._scale_constraints`进行缩放）强制了风险预算的分配。当`budget`为全1向量时，该约束要求`sum(log(w)) >= 0`，这与风险平价的条件一致。

**Section sources**
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L33)
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L554)

## 支持的风险度量类型
`RiskBudgeting`优化器支持多种风险度量，用户可以通过`risk_measure`参数进行选择。这些风险度量被定义在`RiskMeasure`枚举类中。

| 风险度量 | 描述 | 参数 |
| :--- | :--- | :--- |
| `VARIANCE` | 方差 | - |
| `SEMI_VARIANCE` | 半方差 | - |
| `STANDARD_DEVIATION` | 标准差 | - |
| `SEMI_DEVIATION` | 半标准差 | - |
| `MEAN_ABSOLUTE_DEVIATION` | 平均绝对偏差 | - |
| `FIRST_LOWER_PARTIAL_MOMENT` | 一阶下偏矩 | `min_acceptable_return` |
| `CVAR` | 条件风险价值 | `cvar_beta` |
| `EVAR` | 本熵风险价值 | `evar_beta` |
| `WORST_REALIZATION` | 最差实现（最差回报） | - |
| `CDAR` | 条件在险回撤 | `cdar_beta` |
| `MAX_DRAWDOWN` | 最大回撤 | - |
| `AVERAGE_DRAWDOWN` | 平均回撤 | - |
| `EDAR` | 本熵在险回撤 | `edar_beta` |
| `ULCER_INDEX` | 溃疡指数 | - |
| `GINI_MEAN_DIFFERENCE` | 基尼均差 | - |

**Section sources**
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L44-L58)
- [measures.py](file://src/skfolio/measures/_enums.py#L105-L186)

## 约束条件
除了风险预算约束外，`RiskBudgeting`优化器还支持多种其他约束条件，以满足实际投资需求。

- **最小/最大权重约束** (`min_weights`, `max_weights`)：限制每个资产的最低和最高投资比例。例如，`min_weights=0`表示不允许卖空（长仓）。
- **最小预期回报约束** (`min_return`)：要求投资组合的预期回报率不低于某个阈值。该约束在代码中通过引入一个`cp.Parameter`来实现，并与`expected_return`进行比较。
- **交易成本和管理费** (`transaction_costs`, `management_fees`)：这些成本会从预期回报中扣除，影响最终的优化目标。
- **线性约束** (`linear_constraints`)：允许用户定义更复杂的组合约束，例如`"SPX >= 0.10"`（标普500指数权重不低于10%）或`"Equity == 3 * Bond"`（股票总权重是债券的3倍）。

**Section sources**
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L108-L145)
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L266-L268)

## 与风险平价的关系
风险预算优化（Risk Budgeting）是风险平价（Risk Parity）的广义化形式。

- **关系**：当`risk_budget`参数被设置为一个所有元素都相等的向量（特别是全1向量）时，风险预算优化问题就等价于风险平价问题。
- **实现**：在代码中，当用户不指定`risk_budget`（即`None`）时，系统会自动将其设置为`np.ones(n_assets)`。这确保了每个资产的风险贡献相等，从而实现了风险平价。
- **示例**：在`plot_1_risk_parity_variance.py`示例中，通过创建一个未指定`risk_budget`的`RiskBudgeting`模型，成功构建了一个基于方差的风险平价投资组合。

**Section sources**
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L98-L99)
- [risk_budgeting.py](file://src/skfolio/optimization/convex/_risk_budgeting.py#L530)
- [plot_1_risk_parity_variance.py](file://examples/risk_budgeting/plot_1_risk_parity_variance.py#L33-L36)

## 代码示例
以下代码示例展示了如何使用`RiskBudgeting`优化器为不同资产分配不同的风险预算。

```python
# 导入必要的库
from skfolio.optimization import RiskBudgeting
from skfolio import RiskMeasure

# 定义风险预算：为AAPL分配更多风险，为GE和JPM分配较少风险
risk_budget = {asset_name: 1 for asset_name in X.columns}
risk_budget["AAPL"] = 1.5
risk_budget["GE"] = 0.2
risk_budget["JPM"] = 0.2

# 创建风险预算模型，使用CVaR作为风险度量
model = RiskBudgeting(
    risk_measure=RiskMeasure.CVAR,
    risk_budget=risk_budget,
    portfolio_params=dict(name="Risk Budgeting - CVaR"),
)

# 拟合并获取权重
model.fit(X_train)
weights = model.weights_
```

**Section sources**
- [plot_2_risk_budgeting_CVaR.py](file://examples/risk_budgeting/plot_2_risk_budgeting_CVaR.py#L35-L48)

## 应用场景
风险预算优化在投资组合风险管理中有广泛的应用。

- **主动风险管理**：投资者可以根据对不同资产风险的看法，主动调整其风险预算。例如，对某只股票更有信心时，可以为其分配更高的风险预算。
- **因子投资**：可以为不同的风险因子（如价值、动量、规模）分配风险预算，实现基于风险的因子配置。
- **多资产配置**：在跨资产类别（股票、债券、商品）的配置中，风险预算优化可以确保每个类别的风险贡献符合战略目标，避免组合过度集中在某一类别。
- **与协方差收缩结合**：如`plot_3_risk_parity_ledoit_wolf.py`所示，可以将风险预算优化与`ShrunkCovariance`等协方差估计方法结合，提高估计的稳定性和组合的稳健性。

**Section sources**
- [plot_3_risk_parity_ledoit_wolf.py](file://examples/risk_budgeting/plot_3_risk_parity_ledoit_wolf.py#L36-L42)